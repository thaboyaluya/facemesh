<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Password</title>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.11.9/p5.min.js"></script>
    <script src="https://unpkg.com/ml5@1/dist/ml5.min.js"></script>
</head>
<body>

 <h2 id="status">Perform: Blink twice ‚ûù Smile ‚ûù Tilt head left</h2>

    <script>
      let video, facemesh;
      let predictions = [];
      let blinkCount = 0;
      let lastBlinkTime = 0;

      let blinkDone = false;
      let smileDone = false;
      let tiltDone = false;
      let loggedIn = false;

      function setup() {
        createCanvas(640, 480);
        video = createCapture(VIDEO);
        video.size(width, height);
        facemesh = ml5.facemesh(video, () => console.log("FaceMesh loaded!"));
        facemesh.on("predict", results => predictions = results);
        video.hide();
      }

      function draw() {
        image(video, 0, 0, width, height);
        drawKeypoints();

        if (!loggedIn) {
          if (!blinkDone) detectBlink();
          else if (!smileDone) detectSmile();
          else if (!tiltDone) detectTilt();
        }
      }

      function drawKeypoints() {
        for (let i = 0; i < predictions.length; i++) {
          const keypoints = predictions[i].scaledMesh;
          for (let j = 0; j < keypoints.length; j++) {
            const [x, y] = keypoints[j];
            fill(0, 255, 0);
            noStroke();
            ellipse(x, y, 2, 2);
          }
        }
      }

      // üëÄ Detect Blink (2 times)
      function detectBlink() {
        if (predictions.length > 0) {
          const keypoints = predictions[0].scaledMesh;
          const topEye = keypoints[159]; 
          const bottomEye = keypoints[145]; 
          const eyeDist = dist(topEye[0], topEye[1], bottomEye[0], bottomEye[1]);

          if (eyeDist < 5) {
            const now = millis();
            if (now - lastBlinkTime > 300) {
              blinkCount++;
              lastBlinkTime = now;
              console.log("Blink:", blinkCount);
              if (blinkCount >= 2) {
                blinkDone = true;
                document.getElementById("status").innerText = "‚úÖ Blink done! Now smile üòÉ";
              }
            }
          }
        }
      }

      // üòÉ Detect Smile
      function detectSmile() {
        if (predictions.length > 0) {
          const keypoints = predictions[0].scaledMesh;
          const leftMouth = keypoints[61];
          const rightMouth = keypoints[291];
          const topLip = keypoints[13];
          const bottomLip = keypoints[14];

          const mouthWidth = dist(leftMouth[0], leftMouth[1], rightMouth[0], rightMouth[1]);
          const mouthHeight = dist(topLip[0], topLip[1], bottomLip[0], bottomLip[1]);

          if (mouthWidth / mouthHeight > 3) { // smiling ratio
            smileDone = true;
            document.getElementById("status").innerText = "‚úÖ Smile done! Now tilt head left ‚ÜôÔ∏è";
            console.log("Smile detected");
          }
        }
      }

      // ‚ÜôÔ∏è Detect Head Tilt
      function detectTilt() {
        if (predictions.length > 0) {
          const keypoints = predictions[0].scaledMesh;
          const leftCheek = keypoints[234];
          const rightCheek = keypoints[454];

          if (leftCheek[1] < rightCheek[1] - 15) { // left cheek higher than right
            tiltDone = true;
            loggedIn = true;
            document.getElementById("status").innerText = "üéâ Login Successful!";
            console.log("Tilt detected -> Logged in");
          }
        }
      }
    </script>
    
   
</body>
</html>